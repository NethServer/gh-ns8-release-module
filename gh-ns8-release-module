#!/usr/bin/env bash

# Enable debugging and logging of shell operations
if [ -n "$DEBUG" ]; then
set -x
PS4='+${LINENO}: '
fi

# Get script directory
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

# Source library files
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/semver.sh"
source "$SCRIPT_DIR/lib/github-api.sh"
source "$SCRIPT_DIR/lib/display.sh"

# Source command files
source "$SCRIPT_DIR/commands/create.sh"
source "$SCRIPT_DIR/commands/check.sh"
source "$SCRIPT_DIR/commands/comment.sh"
source "$SCRIPT_DIR/commands/clean.sh"

# Function to display usage instructions
function usage() {
  echo "Usage: $0 [create|check|comment|clean] --repo <repo-name> [options]"
  echo ""
  echo "Options:"
  echo "  --repo <repo-name>         The GitHub NethServer 8 module repository (e.g., owner/ns8-module)."
  echo "  --release-refs <commit-sha> Commit SHA to associate with the release."
  echo "  --release-name <name>      Specify the release name (must follow semver format)."
  echo "  --testing                  Create a testing release."
  echo "  --draft                    Create a draft release."
  echo "  --with-linked-issues       Include linked issues from PRs in release notes."
  echo "  -h, --help                 Display this help message."
  exit 1
}

# The first argument must be `create`, `check`, `comment`, or `clean`
if [[ "$1" =~ ^(create|check|comment|clean)$ ]]; then
  subcommand=$1
  shift
else
  echo 'The first argument must be `create`, `check`, `comment`, or `clean`'
  usage
fi

testing_arg=0
with_linked_issues_arg=0
# Parse command line arguments
while [ $# -gt 0 ]; do
  case "$1" in
  --repo)
    repo_arg="$2"
    shift
    ;;
  --release-refs)
    release_refs_arg="$2"
    shift
    ;;
  --release-name)
    release_name_arg="$2"
    shift
    ;;
  --testing)
    testing_arg=1
    ;;
  --draft)
    draft_arg="--draft"
    ;;
  --with-linked-issues)
    with_linked_issues_arg=1
    ;;
  -h|--help)
    usage
    ;;
  *)
    echo "Unknown argument: $1"
    usage
    ;;
  esac
  shift
done

# Validate and get repository
repo_arg=$(get_or_validate_repo "$repo_arg")
if [ $? -ne 0 ]; then
  exit 1
fi

# Get or validate commit SHA and target
if [ -n "$release_refs_arg" ] || [ "$subcommand" == "create" ]; then
  commit_info=$(get_or_validate_commit "$repo_arg" "$release_refs_arg")
  if [ $? -ne 0 ]; then
    exit 1
  fi
  read -r release_refs_arg target <<< "$commit_info"
fi

# If the argument `--testing` is not provided then the `--release-name` argument must be present
if [ $testing_arg == 0 ] && [ -z "$release_name_arg" ] && [ "$subcommand" != "check" ] && [ "$subcommand" != "clean" ]; then
  echo "Please provide the release name using the --release-name flag"
  exit 1
fi

# If the argument `--release-name` is provided check if the release name is in
# valid semver format
if [ ! -z "$release_name_arg" ]; then
  if ! is_semver "$release_name_arg"; then
    echo "Invalid semver format for release name"
    exit 1
  fi
fi


# Check if the subcommand is `create`, `check`, `comment`, or `clean`
if [ "$subcommand" == "create" ]; then
  create_command_main "$repo_arg" "$release_name_arg" "$testing_arg" "$draft_arg" "$target" "$with_linked_issues_arg"

elif [ "$subcommand" == "check" ]; then
  # Get the name the latest release that is not a prerelease
  latest_release=$(gh release list --repo "$repo_arg" --exclude-pre-releases --json tagName --limit 1 --order desc --jq '.[0].tagName')

  # Get the commit sha for the latest releases
  latest_release_sha=$(gh api repos/"$repo_arg"/git/ref/tags/"$latest_release" --jq '.object.sha')

  # Check if there are changes to release
  check_command_main "$repo_arg" "$latest_release" "$latest_release_sha"

elif [ "$subcommand" == "comment" ]; then
  comment_command_main "$repo_arg" "$release_name_arg"

elif [ "$subcommand" == "clean" ]; then
  clean_command_main "$repo_arg" "$release_name_arg"

fi
